\subsubsection{Design of the posterior and maximum likelihood estimator}

\newcommand{\childrennode}{\mathcal{C}}

% Design of the posterior

Now that we have a way to generate trees, we need to define an explicit stochastic relationship between the abundance
data and the structure of the tree.
Such inevitably exists, as when observing $T$, the abundance of an entity that isn't present in $T$ is necessarily 0.
Similarly, it is highly likely that when observing the presence of certain entities in $T$ that induces a high abundance of
another neighbour entity (interaction between bacteria). \\

For context, we recall that $X$ is a matrix of shape $(L, U)$,
where $L$ is the maximum precision level of the trees (assumed to be the same for all trees for now) and $U$ the maximum number of entities at each depth of the trees.
We denote by $X^{(\ell)}$ the $\ell$-th line of the abundance matrix, for which up to $U_{\ell}$ elements should be non-zero. \\

We assume the following framework:
\begin{itemize}
    \item Let $X = (X^{1}, \dots, X^{(L)})$ a given abundance matrix associated to a tree $T$.
    \item We denote $X^{(\ell)} = (x_1^{(\ell)}, \dots, x_{K_{\ell}}^{(\ell)})$ the abundance vector at layer $\ell$.
    \item For an abundance node $x_k^{(\ell)}$, we denote by $\childrennode(x_k^{(\ell)})$ the set of abundance children associated to that node.
          Also, we introduce the notation $T^{(\ell + 1)}_k$, the vector of activation states $(u_j^{(\ell+1)})_j$ of the children of the node $u_k^{(l)}$ in $T$ (restriction of $T^{(\ell)}$ to the children of the node $u_k^{(\ell)}$).
    \item $X^{(1)} = [1, 0, \dots, 0]$, since it's the root of the tree, only one entity gets the whole weight.
    \item Since we would like a simple explicit model at first, we design a posterior $p_{\theta}(X|T)$ which is markovian relatively to the layers of the tree,
            so that the abundance at the next layer are only impacted by the previous layers abundance for now:
            $$
            p_{\theta}(X^{(\ell)} | X^{(1:\ell-1)}, T) = p_{\theta}(X^{(\ell)} | X^{(\ell-1)}, T^{(\ell)})
            $$
    \item In addition to the markovianity, we assume that at a given layer, the abundance only depends of their respective parent and their siblings:
    $$p(X^{(\ell+1)} | X^{(\ell)}, T^{(\ell+1)}) = \prod_{k=1}^{K_{\ell}} p(\childrennode(x_k^{(\ell)}) | x_k^{(\ell)}, T^{(\ell+1)})$$
    \item Each value in $X^{(\ell)}$ is restricted by the following set of constraints due to the nature of the abundance in a tree structure:
            \begin{itemize}
                \item If node $k$ at layer $\ell-1$ has one child, then its abundance value is the same for the child node.
                \item If node $k$ at layer $\ell-1$ has at least two children, the children abundance sums to the parent's abundance value.
            \end{itemize}
    \item Since we deal with proportions in abundance vectors, it seems natural to use the Dirichlet distribution in first assumption.
          Hence, we assume that for all $l \geq 2$, if $|\childrennode(x_k^{(\ell)})| > 1$,
            $$\childrennode(x_k^{(\ell+1)}) | x_k^{(\ell)}, T \sim x_k^{(\ell)} \mathcal{D}(\alpha_k^{(\ell)} \odot T^{(\ell+1)})$$
          We denote by $f_{\alpha_k^{(\ell)} \odot T^{(\ell+1)}}$ the density of this distribution, parameterized by $\alpha_k^{(\ell)} \odot T^{(\ell+1)}$ which denotes
          a masked version of $\alpha_k^{(\ell)}$ relatively to the activated nodes of the tree at $T^{(\ell)}$.
          Notice that setting this distribution framework enables us to verify the constraints given above by renormalizing the layer with the obtained weights.
          Naturally, if $|\childrennode(x_k^{(\ell)})| = 1$, we have $\childrennode(x_k^{(\ell)}) \sim \delta_{x_k^{(\ell)}}\left(\childrennode(x_k^{(\ell)})\right)$ to respect the constraints.
\end{itemize}

Noting the previous framework, the whole abundance distribution conditionally to a tree $T$ can be written as (see proposition \ref{proposition:abundance_posterior_bernoulli_tree}):
$$
p(X|T) = \delta_{e_1}(X^{(1)}) \prod_{l=1}^{L-1} \prod_{k=1}^{K_{\ell}} \left(
        \delta_{x_k^{(\ell)}}\left(\childrennode(x_k^{(\ell)})\right)^{\mathds{1}_{|\childrennode(x_k^{(\ell)})| = 1}}
        \frac{1}{x_k^{(\ell)}} f_{\alpha_k^{(\ell)} \odot T^{(\ell+1)}} \left(\frac{\childrennode(x_k^{(l))}}{x_k^{(\ell)}}\right)^{\mathds{1}_{|\childrennode(x_k^{(\ell)})| > 1}}
        \right)
$$

% Optimization
One can then compute a maximum likelihood estimator of each $\alpha_k^{(\ell)}$ using a fixed point iterative algorithm that is described
in the appendix as proposition \ref{MLE_abundance_bernoulli_tree}:
$$
\fbox{
    \displaystyle
    \alpha_{k,v}^{(\ell)} \leftarrow \psi^{-1} \left(\frac{\sum_{i=1}^n \mathds{1}_{|\childrennode(x_{k,i}^{(\ell)})| > 1} \mathds{1}_{v \in \mathcal{V}(\alpha_k^{(\ell)}, T_i)} \left[ \psi\left(\sum_{u \in \mathcal{V}(\alpha_k^{(\ell)}, T_i)} \alpha_{k,u}^{(\ell)}\right) + \log \frac{\left[\childrennode(x_{k,i}^{(\ell)})\right]_v}{x_{k,i}^{(\ell)}} \right]}
    {\sum_{i=1}^n \mathds{1}_{|\childrennode(x_{k,i}^{(\ell)})| > 1} \mathds{1}_{v \in \mathcal{V}(\alpha_k^{(\ell)}, T_i)}} \right) \right)
}
$$